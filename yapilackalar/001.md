## Yapılan Geliştirmeler

1. SQLLoader için DSL template fonksiyonları eklendi.
2. Email helper: rate limiting + retry + geçici hata algılama.
3. DB: basit prepared statement cache + kullanım metrikleri (prepare/hit sayısı) + kısayol fonksiyonları.
4. RAR/7z için saf Go fallback API iskeleti (şimdilik not implemented) – ileride genişletilebilir.
5. SQL Server stored procedure OUT parametreleri için `spOutDecl`, `spOutVal` fonksiyonları eklendi.

---

## 1. SQLLoader DSL Fonksiyonları
`pkg/helpers/sqlloader.go` içindeki yeni fonksiyonlar (template.FuncMap):

| Fonksiyon | Açıklama |
|-----------|----------|
| `whereJoin(sep, parts...)` | Boş olmayan parçaları filtreleyip `WHERE a SEP b SEP c` üretir. `sep` boş ise `AND`. |
| `andJoin(parts...)` | `whereJoin("AND", ...)` kısaltması. |
| `orJoin(parts...)` | `whereJoin("OR", ...)` kısaltması. |
| `inList(col, slice)` | Slice uzunluğuna göre `col = ?` (1 eleman) / `col IN (?,?,...)` / boşsa `1=0`. |
| `setList(map)` | Alfabetik sıralı `SET col1=?, col2=? ...` üretir. |
| `spOutDecl(name, type)` | `@name TYPE OUTPUT` döndürür (SQL Server). |
| `spOutVal(name)` | `@name` döndürür. |

### Örnekler

```sql
-- Filtreli liste (boş parçalar atlanır)
{{ andJoin (inList "u.id" .IDs) (inList "u.status" .Statuses) (trim .ExtraCondition) }}

-- Dinamik SET (alfabetik sıralı):
UPDATE users {{ setList .UpdateMap }} WHERE id = ${id};

-- IN kullanımı (bind aşamasında slice genişler):
SELECT * FROM users WHERE id IN (${ids}); -- veya DSL: {{ inList "id" .IDs }}

-- Stored procedure OUT param (SQL Server):
EXEC MyProc {{ spOutDecl "o_id" "INT" }}, {{ spOutDecl "o_status" "NVARCHAR(20)" }};
SELECT {{ spOutVal "o_id" }} AS id, {{ spOutVal "o_status" }} AS status;
```

> Not: Template fonksiyonları `?` placeholder sayısını üretir; gerçek değer bağlama `bindNamedToQ` içinde `${name}` parametreleri üzerinden yapılır. Slice parametreleri otomatik genişler (`${ids}` => `?,?,?`). `inList` fonksiyonunu kullanırsanız, parametre değerleri yine parametre haritanızda bulunmalı (ör. tek eleman senaryosu için). Çoklu placeholder durumda sıradaki slice elemanları sırasıyla eşleşir.

---

## 2. Email Helper – Rate Limiting & Retry
`helpers.SMTPCfg` yeni alanlar:

| Alan | Anlamı |
|------|--------|
| `RateInterval` | Pencere süresi (ör. 1m). |
| `RateMax` | Pencere başına maksimum gönderim (<=0 ise limitsiz). |
| `RetryAttempts` | Toplam deneme sayısı (<=1 => retry yok). |
| `RetryDelay` | Denemeler arası gecikme. |

Geçici (transient) sayılan hatalar: network timeout / temporary, SMTP 421/450/451/452 kodları içerliği, "timeout" içeren ifadeler.

### Örnek
```go
cfg := helpers.SMTPCfg{
	Host: "smtp.example.com", Port: 587, User: "user", Pass: "pass", UseTLS: true,
	Timeout: 5 * time.Second,
	RateInterval: time.Minute, RateMax: 30,
	RetryAttempts: 3, RetryDelay: 2 * time.Second,
}
err := helpers.SendEmail(ctx, cfg, "no-reply@example.com", []string{"to@ex.com"}, nil, nil,
	"Konu", "Text Body", "<b>HTML</b>", []string{"/path/ek.pdf"})
```

---

## 3. DB Prepared Statement Cache & Metrikler
`db.Config` yeni alanlar:
- `EnableStmtCache bool`
- `StmtCacheSize int` (0 veya <0 sınırsız; >0 ise basit en eski silme)

### Kullanım
```go
// Init sırasında:
db.Init(db.Config{Driver: "postgres", DSN: dsn, EnableStmtCache: true, StmtCacheSize: 200})

// Çalıştırma (Exec):
rows, err := db.ExecPrepared(ctx, "UPDATE users SET last_login=${ts} WHERE id=${id}", map[string]any{"ts": time.Now(), "id": 42})

// Query:
var users []User
err = db.QueryPrepared(ctx, "SELECT * FROM users WHERE status=${st}", map[string]any{"st": "ACTIVE"}, &users)

// Metrikler:
prepCount, hitCount := db.StmtMetrics()
```

Loglarda (EnableLogging true ise) `prep` ve `hit` alanları görünür.

---

## 4. RAR / 7z Fallback Yapısı
Mevcut CLI tabanlı fonksiyonlar: `ExtractRar`, `Extract7z`. Saf Go iskeletleri:
```go
if helpers.HasNativeRAR() {
	_ = helpers.ExtractRARNative(src, dest)
} else {
	_ = helpers.ExtractRar(src, dest) // CLI
}
```
`*_Native` fonksiyonları şimdilik `not implemented` döner; ileride üçüncü parti kütüphaneler eklenebilir (örn. RAR için `rardecode`).

---

## 5. Stored Procedure OUT Param Yardımcıları (SQL Server)
Template içinde:
```sql
EXEC MyProc {{ spOutDecl "o_id" "INT" }}, {{ spOutDecl "o_msg" "NVARCHAR(100)" }};
SELECT {{ spOutVal "o_id" }} AS id, {{ spOutVal "o_msg" }} AS message;
```

---

## Özet / Sonraki Adımlar (Opsiyonel İyileştirme Fikirleri)
- Gerçek *sql.Stmt tabanlı cache (driver seviyesinde) – gerekirse eklenebilir.
- Pure Go RAR/7z desteği için bağımsız paket seçimi.
- Email için token bucket tabanlı daha ince taneli rate limiter.
- Template tarafında otomatik OUT param değer toplama helper (şimdilik manuel SELECT). 

Bu dökümantasyon güncellemeleri ile mevcut geliştirmeler kullanılabilir durumda.